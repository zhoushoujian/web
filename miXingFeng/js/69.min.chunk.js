(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{337:function(e,t,a){"use strict";var i=a(0),n=a.n(i);t.a=(()=>n.a.createElement("div",{className:"top-status-bar"}))},365:function(e,t,a){"use strict";a(353);var i=a(354),n=a.n(i),l=(a(348),a(349)),r=a.n(l),o=a(0),s=a.n(o),c=a(4),d=a(95),f=a(375),u=a.n(f),m=a(361),p=a(38),g=a(3),h=a(8),w=a(2),b=a(11),v=a(9),O=a(1),S=a(20),j=a(34);function F(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){return function i(n,l){try{var r=t[n](l),o=r.value}catch(e){return void a(e)}if(!r.done)return Promise.resolve(o).then(function(e){i("next",e)},function(e){i("throw",e)});e(o)}("next")})}}let $;new RegExp("\\biPhone\\b|\\biPod\\b","i").test(navigator.userAgent)&&($={onTouchStart:e=>e.preventDefault()});let E=0;t.a=Object(d.connect)(e=>({username:e.login.username,token:e.login.token,downloadingFileList:e.fileServer.downloadingFileList,lastFileSearchResult:e.fileServer.lastFileSearchResult,lastSearchAllFileResult:e.fileServer.lastSearchAllFileResult,setMobile:e.myInfo.setMobile,setPermisssions:e.myInfo.setPermisssions,downloadedFileList:e.fileServer.downloadedFileList,fileSharePosition:e.fileServer.fileSharePosition}),()=>({}))(({username:e,token:t,downloadingFileList:a,downloadedFileList:i,lastFileSearchResult:l,lastSearchAllFileResult:d,setMobile:f,setPermisssions:y={},fileDataList:N=[],original:k,height:M,fileSharePosition:x})=>{const D="fileDownloading"===k,L=Object(j.j)(),T=Object(c.useHistory)();Object(o.useEffect)(()=>()=>{L&&$dispatch(Object(O.q)(E))},[]);const P=()=>{window.cancelMenuFirst=!0,document.addEventListener("backbutton",I,!1)},I=()=>{window.cancelMenuFirst=!1;const e=document.querySelector(".am-action-sheet-button-list div:nth-last-child(1)");e&&e.click(),e&&e.click()},R=(()=>{var e=F(function*(e,t,a,n,l,o,c,d){try{document.removeEventListener("backbutton",g.r,!1),document.addEventListener("deviceready",P),e=Object(v.J)(e);let f="下载",u="fileFinished"===k;u?f="打开":"fileShare"!==k&&"fileSearch"!==k||i.some(function(e){return!(Object(v.H)(e.filenameOrigin)!==Object(v.H)(l)||e.status&&"downloaded"!==e.status||(f="打开",u=!0,0))});const m=[f,"分享","删除","取消"];"fileFinished"===k||"downloaded"===c?(m.splice(1,1),o=""):"fileShare"===k&&(o=` ${o}`),"fileShare"!==k&&"fileSearch"!==k||(isCordova?y.removeFile||m.splice(2,1):(m.splice(1,1),y.removeFile||m.splice(1,1)));const h={options:m,cancelButtonIndex:m.length-1,destructiveButtonIndex:m.length-2,message:`大小: ${Object(v.b)(t)}${o}`,title:e,maskClosable:!0,"data-seed":"logId",wrapProps:$};r.a.showActionSheetWithOptions(h,function(i){switch(logger.info("file manage showMenu buttonIndex",i),i){case 0:u?C(e,l):Object(v.M)(e,n,t,a,!1,l,T,C,d);break;case 1:if("fileFinished"===k||"downloaded"===c)Object(g.j)("提示",s.a.createElement(p.a,{textFragment:`确定从本地删除 <span class="delete-alert">${e}</span> 吗`}),"确定",function(){Object(v.G)(Object(v.H)(l),"file").then(function(){J(k,l)}).catch(function(t){logger.error("删除文件过程中发生了错误 isFileFinished",t.stack||t.toString()),Object(g.q)(t,`fileManage removeFileFromDownload filename ${e}`)})});else if(isCordova){const i=`${w.a.appStaticDirectory}#/show_file_info?filename=${e}&fileSize=${Object(v.b)(t)}&filePath=${a}`;Object(g.w)({title:e,description:"我分享了一个文件,快来看看吧",thumb:`${w.a.appStaticDirectory}logo.png`,webpageUrl:i})}else y.removeFile&&U(e,l);break;case 2:isCordova&&("fileShare"===k||"fileSearch"===k)&&"downloaded"!==c&&y.removeFile&&U(e,l);break;default:logger.warn("buttonIndex default")}window.cancelMenuFirst=!1,document.removeEventListener("backbutton",I),document.removeEventListener("deviceready",P),document.addEventListener("backbutton",g.r,!1)})}catch(e){logger.error("fileManage showMenu err",e)}});return function(t,a,i,n,l,r,o,s){return e.apply(this,arguments)}})(),U=(a,i)=>{if(!t)return goRoute(void 0,"/login");const n={username:e||f,token:t,filename:a,type:"default-file"};Object(g.j)("提示",s.a.createElement(p.a,{textFragment:`确定从服务器删除 <span class="delete-alert">${a}</span> 吗`}),"确定",()=>(Object(g.B)(),axios.delete(h.a.delFileV2,{data:n}).then(e=>{if(window.toast.hide(),!window.cancelAxiosRequest)return"file_deleted"===e.result?(alert("文件已删除!"),$dispatch(Object(b.i)(e.token)),J(k,i)):"success"===e.result?(alert("删除成功!"),$dispatch(Object(b.i)(e.token)),J(k,i)):void alert("删除失败!")}).catch(e=>{window.toast.hide(),logger.error("删除文件过程中发生了错误",e.stack||e.toString()),Object(g.q)(e,`delFile dataInfo: ${JSON.stringify(n)}`)}).finally(()=>{window.cancelAxiosRequest=!1})))},J=(e,t)=>{if("fileSearch"===e){let e,a;l.some((a,i)=>a.filenameOrigin===t&&(e=i,!0));const i=JSON.parse(JSON.stringify(l));i.splice(e,1),d.some((e,i)=>e.filenameOrigin===t&&(a=i,!0));const n=JSON.parse(JSON.stringify(d));d.splice(a,1),$dispatch(Object(O.u)(i)),$dispatch(Object(O.D)(n))}},C=(e,t)=>{let a=u.a.lookup(e);a||(a="text/plain",alert("不支持打开的的文件类型，请提交反馈")),Object(v.x)(e,a,Object(v.H)(t))},H=(()=>{var e=F(function*(e,t,i,n,l,r){e=Object(v.J)(e),"fileFinished"===k?C(e,l):"fileShare"===k||"fileSearch"===k?yield Object(v.M)(e,t,i,n,!1,l,T,C,r):"fileDownloading"===k&&a.some(function(a){return a.filenameOrigin===l&&(l=l.replace(/^downloading_/,""),logger.info("downloadOrOpenFile filenameOrigin",l),"失败"===a.progress||"已取消"===a.progress?Object(v.M)(e,t,i,n,!0,l,T,C,r):(window.eventEmit.$emit(`FileTransfer-${l}`,"abort"),setTimeout(function(){window[`cancel-download-${Object(v.H)(l)}`]||Object(v.M)(e,t,i,n,!0,l,T,C,r)},500)),!0)})});return function(t,a,i,n,l,r){return e.apply(this,arguments)}})(),_=(e,t)=>s.a.createElement(o.Fragment,null,s.a.createElement("div",{className:`file-content ${D?"downloading":""}`,onClick:H.bind(void 0,e.filename,e.uploadUsername,e.fileSize,e.filePath,e.filenameOrigin,e.md5)},s.a.createElement("div",{className:`num ${Object(g.d)(t+1)}`},t+1),s.a.createElement("div",{className:"file-info"},s.a.createElement("div",{className:`info ${"fileFinished"===k?"center":""} ${e.downloaded?"downloaded":""}`},s.a.createElement("div",{className:`filename ${D?"downloading":""}`,dangerouslySetInnerHTML:{__html:e.filename}}),e.downloaded&&s.a.createElement("div",{className:"downloaded-text"},"已下载"),D?s.a.createElement("div",{className:"file-size downloading"},e.progress):null),s.a.createElement("div",{className:"upload-info"},s.a.createElement("div",{className:`upload-user ${D?"downloading":""}`},`${"fileFinished"!==k?e.uploadUsername:""}${(e=>e?"fileDownloading"===k?"":("number"==typeof e&&(e=new Date(e).format("yyyy-MM-dd"))," "+e.split(" ")[0]):"")(e.date)}`),"fileShare"===k||"fileSearch"===k?s.a.createElement("div",{className:`file-size ${Object(g.d)(t+1)}`},Object(v.b)(e.fileSize)):D?s.a.createElement("div",{className:"download-progress"},s.a.createElement(n.a,{percent:e.received?e.received/e.fileSize*100:0,position:"normal"})):null))),D?s.a.createElement("div",{className:"move-downloading-item fa fa-remove",onClick:((e,t)=>{Object(g.j)("提示",s.a.createElement(p.a,{textFragment:`确定要移除下载 <span class="delete-alert">${e}</span> 吗`}),"确定",()=>{const e=Object(v.H)(t);window.eventEmit.$emit(`FileTransfer-${e}`,"abort"),window[`remove-download-${e}`]=!0,setTimeout(()=>{window[`remove-download-${e}`]=!1},1500);const{downloadingFileList:a}=$getState().fileServer,i=JSON.parse(JSON.stringify(a));for(const e in a)if(i[e].filenameOrigin===t){i.splice(e,1),$dispatch(Object(O.n)(i)),Object(S.c)(t);break}})}).bind(void 0,e.filename,e.filenameOrigin)}):s.a.createElement("div",{className:"menu",onClick:R.bind(void 0,e.filename,e.fileSize,e.filePath,e.uploadUsername,e.filenameOrigin,e.date,e.status,e.md5)},s.a.createElement("div",{className:"dot"}),s.a.createElement("div",{className:"dot"}),s.a.createElement("div",{className:"dot"})));let q=0;return L&&x&&(q=x),s.a.createElement("div",{className:"file-manage-container"},M?s.a.createElement(m.a,{width:window.screen.width,height:M,rowCount:N.length,rowHeight:66,onScroll:({scrollTop:e})=>{E=e,L&&x&&$dispatch(Object(O.q)(0))},scrollTop:q||void 0,rowRenderer:({key:e,index:t,style:a})=>s.a.createElement("div",{key:e,style:a,className:"file-list"},_(N[t],t))}):N.map((e,t)=>s.a.createElement("div",{className:"file-list",key:e.filenameOrigin},_(e,t))))})},560:function(e,t,a){"use strict";a.r(t);var i=a(0),n=a.n(i),l=a(95),r=a(402),o=a(337),s=a(38),c=a(3),d=a(365),f=a(8),u=a(1),m=a(9),p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var i in a)Object.prototype.hasOwnProperty.call(a,i)&&(e[i]=a[i])}return e};window.startToUploadFile=!1;t.default=Object(l.connect)(e=>({fileList:e.fileServer.fileList,username:e.login.username,token:e.login.token,fileSubmitStatus:e.fileServer.fileSubmitStatus,setMobile:e.myInfo.setMobile}),()=>({}))(({fileList:e,fileSubmitStatus:t,token:a,username:l,setMobile:g})=>{const h=Object(i.useCallback)(e=>(logger.info("FileServer acceptedFiles"),a?e&&e[0]?void v(e[0]):alert("没有待上传的文件"):goRoute(void 0,"/login")),[e]),{getRootProps:w,getInputProps:b}=Object(r.a)({onDrop:h}),v=e=>{if(/#|%/g.test(e.name))alertDialog("文件名不能包含%或#");else{if(!(e.size>104857600))return $dispatch(Object(u.r)(`${e.name} 正在读取...`)),Object(m.a)(e).then(t=>{const{MD5Value:a,MD5ValueError:i}=t;logger.info("fileServer handleMD5 MD5Value",a),a&&!i?O(e,a):($dispatch(Object(u.r)("选择一个文件上传")),alertDialog("文件读取失败，请更换文件重试"))}).catch(e=>{logger.error("fileServer handleMD5 err",e)});alertDialog("文件大小不可以超过100MB")}},O=(t,a)=>{if(window.startToUploadFile)return alert("一次只能上传一个文件，请勿重复上传");{window.startToUploadFile=!0;const i=t.name;let l=!1;$dispatch(Object(u.r)("选择一个文件上传"));for(const r in e)e[r].filename===i&&(l=!0,Object(c.j)("提示",n.a.createElement(s.a,{textFragment:`已经存在 <span class="delete-alert">${i}</span>(${Number(r)+1}) ，上传将覆盖原文件`}),"确定",()=>(logger.info("overwrite file true",e[r].filename),S(t,a)),()=>{logger.info("submitFile overwrite file false",e[r].filename),window.startToUploadFile=!1}));if(!l)return S(t,a)}},S=(()=>{var e=function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){return function i(n,l){try{var r=t[n](l),o=r.value}catch(e){return void a(e)}if(!r.done)return Promise.resolve(o).then(function(e){i("next",e)},function(e){i("throw",e)});e(o)}("next")})}}(function*(e,t){try{const a=e.name;$dispatch(Object(u.r)(`${a} 开始上传...`)),logger.info("fileServer uploadFile MD5Value",t);const i=yield Object(m.g)(a,l||g,t,"default-file","file");if("缺少字段"===i)return window.startToUploadFile=!1,$dispatch(Object(u.r)("选择一个文件上传")),alertDialog("缺少字段");if("上传成功"===i)return $dispatch(Object(u.r)("选择一个文件上传")),window.startToUploadFile=!1,Object(m.w)({msg:"second upload file success"+a}),alertDialog("秒传成功");if("没有匹配"===i){const i=new FormData;i.append("files",e),i.append("username",l||g),i.append("type","file"),i.append("md5",t),i.append("registrationID",localStorage.getItem("registrationID")||"");const n=new XMLHttpRequest;n.upload.addEventListener("progress",j.bind(void 0,a),!1),n.addEventListener("error",F,!1),n.open("POST",f.a.uploadFile),n.onreadystatechange=function(){if(window.startToUploadFile=!1,4===n.readyState)if(200===n.status){let e={result:{response:""}};try{e=JSON.parse(n.responseText)}catch(e){}$dispatch(Object(u.r)("选择一个文件上传")),"illegal_filetype"===e.result.response?alert("非法的文件名"):"more_than_100mb"===e.result.response?alert("文件大小超过100MB"):(alert("上传成功！"),Object(m.w)({msg:"upload file success"+a}))}else logger.error("xhr.onreadystatechange not 200, xhr.status",n.status,"xhr.responseText",n.responseText),alert("上传失败")},n.send(i)}}catch(e){$dispatch(Object(u.r)("选择一个文件上传")),window.startToUploadFile=!1}});return function(t,a){return e.apply(this,arguments)}})(),j=(e,t)=>{if(t.lengthComputable){const a=Math.round(100*t.loaded/t.total);$dispatch(Object(u.r)(`${a.toString()}% - ${e}`))}else window.startToUploadFile=!1,$dispatch(Object(u.r)("选择一个文件上传"))},F=e=>{alert("上传失败"),window.startToUploadFile=!1,$dispatch(Object(u.r)("选择一个文件上传")),logger.error("上传失败",e)};return n.a.createElement("div",{className:"file-server"},n.a.createElement(o.a,null),n.a.createElement("h2",{className:"head"}," 文件列表 "),n.a.createElement("div",{className:"upload-area"},n.a.createElement("div",w(),n.a.createElement("input",p({},b(),{multiple:!1})),n.a.createElement("p",null,t))),n.a.createElement("div",{className:"file-container"},e&&e.length?n.a.createElement(d.a,{fileDataList:e,original:"fileShare",height:window.screen.height-170}):n.a.createElement("img",{alt:"",className:"empty-content-pic",src:"./imgs/album.png"})))})}}]);